name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      backend_only:
        description: 'Deploy backend only'
        required: false
        type: boolean
        default: false
      frontend_only:
        description: 'Deploy frontend only'
        required: false
        type: boolean
        default: false
      skip_health_check:
        description: 'Skip health check'
        required: false
        type: boolean
        default: false

env:
  DEPLOY_PATH: /home/ubuntu/single-server-3tier-webapp
  FRONTEND_DEPLOY_PATH: /var/www/bmi-health-tracker
  DB_NAME: bmidb
  DB_USER: bmi_user

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
        log-public-key: true

    - name: Configure SSH to skip host key checking
      run: |
        mkdir -p ~/.ssh
        cat >> ~/.ssh/config <<EOF
        Host ${{ secrets.EC2_HOST }}
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        chmod 600 ~/.ssh/config

    - name: Test SSH Connection
      run: |
        ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSH connection successful'"

    - name: Check if deployment exists
      id: check_deployment
      run: |
        DEPLOYMENT_EXISTS=$(ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "[ -d ${{ env.DEPLOY_PATH }} ] && echo 'true' || echo 'false'")
        echo "exists=$DEPLOYMENT_EXISTS" >> $GITHUB_OUTPUT
        echo "Deployment exists: $DEPLOYMENT_EXISTS"

    - name: Create backup (if deployment exists)
      if: steps.check_deployment.outputs.exists == 'true'
      run: |
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
          mkdir -p ~/bmi_deployments_backup
          if [ -d "${{ env.DEPLOY_PATH }}" ]; then
            echo "Creating backup..."
            cp -r ${{ env.DEPLOY_PATH }} ~/bmi_deployments_backup/backup_${TIMESTAMP}
            echo "Backup created at ~/bmi_deployments_backup/backup_${TIMESTAMP}"
          fi
        EOF

    - name: Deploy application
      run: |
        ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
          set -e
          
          # Load NVM if exists
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          
          # Clone or pull repository
          if [ ! -d "${{ env.DEPLOY_PATH }}" ]; then
            echo "Fresh deployment - cloning repository..."
            git clone https://github.com/${{ github.repository }}.git ${{ env.DEPLOY_PATH }}
          else
            echo "Updating existing deployment..."
            cd ${{ env.DEPLOY_PATH }}
            git fetch origin
            git reset --hard origin/main
          fi
          
          cd ${{ env.DEPLOY_PATH }}
          
          # Deploy backend
          if [ "${{ github.event.inputs.frontend_only }}" != "true" ]; then
            echo "Deploying backend..."
            cd backend
            npm install
            
            # Restart backend with PM2
            if pm2 describe bmi-backend > /dev/null 2>&1; then
              echo "Restarting existing PM2 process..."
              pm2 restart bmi-backend
            else
              echo "Starting new PM2 process..."
              pm2 start server.js --name bmi-backend
              pm2 save
            fi
            cd ..
          fi
          
          # Deploy frontend
          if [ "${{ github.event.inputs.backend_only }}" != "true" ]; then
            echo "Deploying frontend..."
            cd frontend
            npm install
            npm run build
            
            # Deploy to Nginx
            sudo mkdir -p ${{ env.FRONTEND_DEPLOY_PATH }}
            sudo cp -r dist/* ${{ env.FRONTEND_DEPLOY_PATH }}/
            sudo chown -R www-data:www-data ${{ env.FRONTEND_DEPLOY_PATH }}
            sudo systemctl reload nginx
            cd ..
          fi
          
          echo "Deployment completed successfully!"
        ENDSSH

    - name: Health Check
      if: github.event.inputs.skip_health_check != 'true'
      run: |
        ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
          echo "Running health checks..."
          sleep 5
          
          # Check backend health
          HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health || echo "000")
          
          if [ "$HEALTH_CHECK" = "200" ]; then
            echo "âœ… Backend health check passed"
          else
            echo "âŒ Backend health check failed (HTTP $HEALTH_CHECK)"
            exit 1
          fi
          
          # Check PM2 status
          pm2 status
        ENDSSH

    - name: Deployment Summary
      if: always()
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployed to:** ${{ secrets.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ **Application URL:** http://${{ secrets.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ” **Health Check:** http://${{ secrets.EC2_HOST }}/api/health" >> $GITHUB_STEP_SUMMARY
